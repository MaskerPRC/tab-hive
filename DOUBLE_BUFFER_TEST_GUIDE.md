# 双缓冲刷新功能测试指南

## 测试目的

验证双缓冲刷新机制是否正常工作，确保用户在刷新时看不到加载过程和选择器应用过程。

## 测试环境准备

### 1. 测试网站推荐
- 选择加载时间较长的网站（例如：新闻网站、视频网站）
- 最好是需要使用选择器的网站

### 2. 配置选择器
如果测试选择器功能，需要：
1. 在添加网站时配置 `targetSelector`
2. 例如：选择器为 `#player` 或 `.video-container`

## 测试用例

### 测试用例1: 自动刷新（无选择器）

**步骤：**
1. 添加一个网站（不设置选择器）
2. 设置自动刷新间隔为30秒
3. 等待自动刷新触发

**预期结果：**
- 刷新时页面内容应该平滑切换
- 不应该看到白屏或加载中的状态
- 控制台输出 `[Tab Hive] 使用双缓冲刷新`
- 控制台输出 `[Tab Hive] 缓冲iframe加载完成`
- 控制台输出 `[Tab Hive] 双缓冲刷新完成`

### 测试用例2: 自动刷新（有选择器）

**步骤：**
1. 添加一个网站并设置选择器（例如：`#player`）
2. 设置自动刷新间隔为30秒
3. 等待自动刷新触发

**预期结果：**
- 刷新时应该始终只看到选择器指定的元素
- 不应该看到完整页面闪现
- 不应该看到其他元素被隐藏的过程
- 控制台输出 `[Tab Hive] 使用双缓冲刷新`
- 控制台输出 `[Tab Hive] 等待应用选择器到缓冲iframe`
- 控制台输出 `[Tab Hive] 开始应用选择器到指定iframe`
- 控制台输出 `[Tab Hive] 双缓冲刷新完成`

### 测试用例3: 手动刷新（无选择器）

**步骤：**
1. 添加一个网站（不设置选择器）
2. 悬停到网站卡片上
3. 点击刷新按钮（绿色圆形按钮）

**预期结果：**
- 刷新时页面内容应该平滑切换
- 不应该看到白屏或加载中的状态
- 控制台输出 `[Tab Hive] 手动刷新`
- 控制台输出 `[Tab Hive] 双缓冲刷新完成`

### 测试用例4: 手动刷新（有选择器）

**步骤：**
1. 添加一个网站并设置选择器
2. 悬停到网站卡片上
3. 点击刷新按钮

**预期结果：**
- 刷新时应该始终只看到选择器指定的元素
- 不应该看到完整页面闪现
- 平滑切换，无闪烁

### 测试用例5: 快速连续刷新

**步骤：**
1. 添加一个加载较慢的网站
2. 快速连续点击刷新按钮多次

**预期结果：**
- 应该能够处理连续刷新请求
- 不应该出现多个缓冲iframe叠加
- 不应该出现崩溃或错误

### 测试用例6: 全屏模式刷新

**步骤：**
1. 添加一个带选择器的网站
2. 点击全屏按钮进入全屏模式
3. 等待自动刷新或手动刷新

**预期结果：**
- 全屏模式下应该显示完整页面（不应用选择器）
- 刷新应该平滑，无闪烁

## 检查点

### 1. 控制台日志检查

打开浏览器开发者工具（F12），查看控制台输出：

**正常流程应该看到：**
```
[Tab Hive] 使用双缓冲刷新: 网站标题
[Tab Hive] 缓冲iframe加载完成
[Tab Hive] 等待应用选择器到缓冲iframe    // 如果有选择器
[Tab Hive] 开始应用选择器到指定iframe    // 如果有选择器
[Tab Hive] 缓冲准备完成，显示缓冲iframe
[Tab Hive] 刷新主iframe
[Tab Hive] 双缓冲刷新完成
```

### 2. 网络请求检查

在开发者工具的Network标签中：
- 应该看到两次相同URL的请求（一次是缓冲iframe，一次是主iframe）
- URL应该带有时间戳参数 `?_t=timestamp`

### 3. DOM检查

在Elements标签中：
- 刷新时应该临时看到两个iframe
- 一个class包含 `buffer-iframe`
- 缓冲iframe应该有 `buffer-ready` class（准备完成后）
- 刷新完成后，buffer-iframe应该被移除

### 4. 性能检查

- 内存使用应该在刷新前后保持稳定
- 不应该有内存泄漏
- 刷新过程应该流畅，帧率稳定

## 常见问题

### Q: 刷新时仍然能看到白屏
**A:** 检查：
1. 缓冲iframe是否正确创建
2. 控制台是否有错误
3. 网络是否正常

### Q: 选择器没有应用到缓冲iframe
**A:** 检查：
1. 选择器是否正确
2. 是否在非全屏模式下
3. 控制台是否输出选择器应用日志

### Q: 刷新后内存持续增长
**A:** 检查：
1. 缓冲iframe是否被正确移除
2. 事件监听器是否正确清理

### Q: 双缓冲功能不工作
**A:** 检查：
1. 是否使用的是最新代码
2. 浏览器控制台是否有JavaScript错误
3. 检查 `isBufferLoading` 状态是否正确切换

## 测试建议的网站

### 新闻网站（测试普通刷新）
- https://news.google.com
- https://www.bbc.com

### 视频网站（测试选择器）
- https://www.youtube.com (选择器: `#player`)
- https://www.bilibili.com (选择器: `.bilibili-player-video-wrap`)

### 慢速网站（测试双缓冲效果）
- 可以使用Chrome DevTools的Network throttling模拟慢速网络

## 测试报告

测试完成后，请记录：
1. ✅ 通过的测试用例
2. ❌ 失败的测试用例
3. 🐛 发现的问题
4. 💡 改进建议

## 性能基准

- **刷新延迟**: 应该在缓冲iframe加载完成后立即切换（< 100ms）
- **视觉流畅度**: 用户不应该察觉到加载过程
- **内存开销**: 刷新时临时增加一个iframe的内存（约20-50MB）
- **CPU使用**: 刷新时CPU峰值不应超过50%

## 下一步

测试完成后，如果发现问题：
1. 记录详细的复现步骤
2. 截图或录制视频
3. 提交Issue到项目仓库
4. 附上控制台日志

如果一切正常，可以：
1. 调整时间参数以优化体验
2. 测试更多的网站类型
3. 在不同的浏览器/环境中测试

