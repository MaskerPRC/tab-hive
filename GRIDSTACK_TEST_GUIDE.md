# Gridstack 集成测试指南

## 完成的更改

### 1. 安装依赖
✅ 已安装 `gridstack` npm 包

### 2. 创建 Composable
✅ 创建 `src/composables/useGridstack.js`
- 封装 Gridstack 初始化和管理逻辑
- 处理像素和网格单位之间的转换
- 监听 Gridstack 事件并同步到应用状态

### 3. 重构 GridView
✅ 重构 `src/components/GridView.vue`
- 使用 Gridstack 替代自定义拖拽和调整大小逻辑
- 保留所有现有功能（全屏、编辑、删除、URL拖放等）
- 简化代码，移除复杂的碰撞检测算法

### 4. 更新 WebsiteCard
✅ 更新 `src/components/WebsiteCard.vue`
- 拖动手柄现在由 Gridstack 管理
- 移除自定义调整大小手柄（Gridstack 提供自己的手柄）

## 关键特性

### 自动碰撞推开
- **`float: false`** - 当调整元素大小时，自动推开其他元素
- 所有元素保持网格对齐
- 流畅的动画效果

### 网格配置
```javascript
{
  cellHeight: 100,        // 单元格高度
  margin: 20,             // 元素间距
  column: 12,             // 12列网格系统
  float: false,           // 不浮动，自动推开
  animate: true,          // 启用动画
  resizable: {
    handles: 'e, se, s'   // 右、右下、下方向可调整
  },
  draggable: {
    handle: '.drag-handle' // 使用拖动手柄
  }
}
```

### 数据转换
- 像素坐标 ↔ 网格单位自动转换
- 保持与现有数据结构的兼容性
- Gridstack 的 `change` 事件自动同步到应用

## 测试步骤

### 1. 启动应用
```bash
npm run dev
```

### 2. 基础功能测试

#### 2.1 添加网站
- ✅ 点击浮动"+"按钮添加网站
- ✅ 新网站应该出现在网格中
- ✅ 检查是否正确渲染 iframe

#### 2.2 拖拽网站
- ✅ 使用拖动手柄（左上角）拖拽网站
- ✅ 网站应该平滑移动
- ✅ 释放后应该自动对齐到网格点

#### 2.3 调整大小
- ✅ 将鼠标移到网站的右侧、底部或右下角
- ✅ 出现 Gridstack 的调整大小手柄
- ✅ 拖拽调整大小
- ✅ **关键测试**：调整大小时，如果与其他网站碰撞，其他网站应该被自动推开
- ✅ 被推开的网站应该保持网格对齐
- ✅ 释放后所有网站应该对齐到网格点

### 3. 碰撞推开测试 🎯

#### 3.1 水平推开测试
1. 添加两个网站，水平排列
2. 将左侧网站向右拉大
3. **预期**：右侧网站应该被向右推开
4. **验证**：
   - ✅ 右侧网站移动平滑
   - ✅ 右侧网站对齐到网格点
   - ✅ 没有重叠

#### 3.2 垂直推开测试
1. 添加两个网站，垂直排列
2. 将上方网站向下拉大
3. **预期**：下方网站应该被向下推开
4. **验证**：
   - ✅ 下方网站移动平滑
   - ✅ 下方网站对齐到网格点
   - ✅ 没有重叠

#### 3.3 多网站推开测试
1. 添加 4-5 个网站，密集排列
2. 调整中间某个网站的大小，使其扩大
3. **预期**：周围的网站应该被推开，形成连锁反应
4. **验证**：
   - ✅ 所有受影响的网站都被正确推开
   - ✅ 所有网站保持网格对齐
   - ✅ 布局保持整洁，无重叠

#### 3.4 边界测试
1. 在容器边缘添加网站
2. 尝试将其扩大超出边界
3. **预期**：Gridstack 应该阻止或自动调整
4. **验证**：
   - ✅ 网站不会超出容器
   - ✅ 其他网站被正确处理

### 4. 现有功能测试

#### 4.1 全屏模式
- ✅ 点击网站的全屏按钮
- ✅ 网站应该全屏显示
- ✅ 顶部应该显示退出全屏的按钮条
- ✅ 退出全屏后恢复正常布局

#### 4.2 编辑和删除
- ✅ 点击编辑按钮，应该打开编辑对话框
- ✅ 修改网站信息后保存
- ✅ 点击删除按钮，确认后删除网站
- ✅ 删除后布局应该自动调整

#### 4.3 刷新
- ✅ 点击刷新按钮
- ✅ iframe 应该重新加载

#### 4.4 URL 拖放
- ✅ 从浏览器拖拽 URL 到网站卡片
- ✅ 应该更新该网站的 URL

### 5. 控制台日志检查

打开浏览器控制台，查看以下日志：

```
[Gridstack] 初始化 useGridstack
[GridView] onMounted，准备初始化 Gridstack
[Gridstack] 开始初始化 Gridstack
[Gridstack] Gridstack 初始化成功
[Gridstack] 布局变化 - 当拖拽或调整大小时
[Gridstack] 更新网站位置和大小 - 数据同步
```

### 6. 性能测试

#### 6.1 多网站性能
- ✅ 添加 10-20 个网站
- ✅ 测试拖拽和调整大小是否流畅
- ✅ 检查推开算法是否有延迟

#### 6.2 动画流畅度
- ✅ 观察调整大小时的动画
- ✅ 观察推开其他网站时的动画
- ✅ 确保没有卡顿

## 已知改进

### Gridstack 的优势
1. **成熟稳定** - 经过大量项目验证
2. **自动推开** - 原生支持碰撞推开
3. **网格对齐** - 自动处理对齐逻辑
4. **性能优化** - 高效的重排算法
5. **动画效果** - 内置平滑动画
6. **边界处理** - 自动处理各种边界情况

### 移除的复杂逻辑
- ❌ 自定义碰撞检测算法 (`useCollisionDetection.js`)
- ❌ 自定义拖拽逻辑 (`useItemDrag.js`)
- ❌ 自定义调整大小逻辑 (`useItemResize.js`)
- ❌ 自定义碰撞推开算法 (`collisionPushAlgorithm.js`)

## 调试技巧

### 1. 启用 Gridstack 调试
在 `useGridstack.js` 中可以添加更多日志

### 2. 检查网格数据
在控制台中查看：
```javascript
// 查看当前网格的所有元素
console.log(gridInstance.value.engine.nodes)
```

### 3. 查看转换数据
所有像素和网格单位的转换都有日志输出

## 问题排查

### 问题1：Gridstack 未初始化
**症状**：网站不显示或无法拖拽
**解决**：
1. 检查控制台错误
2. 确认 `gridContainer.value` 存在
3. 检查 Gridstack CSS 是否加载

### 问题2：网站不对齐网格
**症状**：网站位置不在网格点上
**解决**：
1. 检查 `PIXEL_TO_GRID_WIDTH/HEIGHT` 转换比例
2. 确认 `cellHeight` 和计算一致

### 问题3：推开不工作
**症状**：调整大小时网站重叠
**解决**：
1. 确认 `float: false` 设置
2. 检查 Gridstack 初始化是否成功
3. 查看控制台是否有错误

## 下一步

如果测试通过：
- ✅ 可以删除旧的碰撞检测代码
- ✅ 简化代码结构
- ✅ 提交代码

如果有问题：
- 📝 记录具体问题
- 🐛 调试并修复
- 🔄 重新测试

